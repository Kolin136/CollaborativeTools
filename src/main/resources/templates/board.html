<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="/static/css/dragula.min.css">
    <script src="/static/js/dragula.min.js"></script>
    <title>Document</title>
</head>
<body>
<div class="container py-5">
    <div class="row">
        <!-- Start lane -->
        <div class="col-12 col-lg-4">
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h3 class="card-title h5 mb-1">

                    </h3>
                </div>
                <div class="card-body">
                    <div class="tasks">
                        <!-- Start task -->
                        <div class="card mb-3 cursor-grab">
                            <div class="card-body">
                                <p class="mb-0"></p>
                                <div class="text-right">
                                    <small class="text-muted mb-1 d-inline-block"></small>
                                </div>
                            </div>
                        </div>
                        <!-- End task -->

                        <!-- Start task -->
                        <div class="card mb-3 cursor-grab">
                            <img class="card-img-top" src="https://source.unsplash.com/sECcwm6BN8w/400x200"
                                 alt="Bootstrap Kanban Board"/>
                            <div class="card-body">
                                <span class="badge bg-primary text-white mb-2">On hold</span>
                                <p class="mb-0">Moving them anywhere else isn't quite possible</p>
                                <div class="text-right">
                                    <small class="text-muted mb-1 d-inline-block">33%</small>
                                </div>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" role="progressbar" style="width: 33%;" aria-valuenow="33"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                        <!-- End task -->
                    </div>
                    <div class="btn btn-primary btn-block">Add task</div>
                </div>
            </div>
        </div>
        <!-- End lane -->
        <!-- Start lane -->
        <div class="col-12 col-lg-4">
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h3 class="card-title h5 mb-1">
                        Backlog
                    </h3>
                    <small class="mb-0 text-muted">
                        Nam pretium turpis et arcu. Duis arcu.
                    </small>
                </div>
                <div class="card-body">
                    <div class="tasks" id="backlog">
                        <!-- Start task -->
                        <div class="card mb-3 cursor-grab">
                            <div class="card-body">
                                <p class="mb-0">You can move these elements between the containers</p>
                                <div class="text-right">
                                    <small class="text-muted mb-1 d-inline-block">25%</small>
                                </div>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                        <!-- End task -->
                        <!-- Start task -->
                        <div class="card mb-3 cursor-grab">
                            <img class="card-img-top" src="https://source.unsplash.com/sECcwm6BN8w/400x200"
                                 alt="Bootstrap Kanban Board"/>
                            <div class="card-body">
                                <span class="badge bg-primary text-white mb-2">On hold</span>
                                <p class="mb-0">Moving them anywhere else isn't quite possible</p>
                                <div class="text-right">
                                    <small class="text-muted mb-1 d-inline-block">33%</small>
                                </div>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" role="progressbar" style="width: 33%;" aria-valuenow="33"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                        <!-- End task -->
                    </div>
                    <div class="btn btn-primary btn-block">Add task</div>
                </div>
            </div>
        </div>
        <!-- End lane -->

        <!-- Start lane -->
        <div class="col-12 col-lg-4">
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h3 class="card-title h5 mb-1">
                        In Progress
                    </h3>
                    <small class="mb-0 text-muted">
                        Aenean posuere, tortor sed cursus feugiat.
                    </small>
                </div>
                <div class="card-body">
                    <div class="tasks" id="progress">
                        <!-- Start task -->
                        <div class="card mb-3 cursor-grab">
                            <div class="card-body">
                                <span class="badge bg-danger text-white mb-2">Bug</span>
                                <p class="mb-0">Moving them anywhere else isn't quite possible</p>
                                <div class="text-right">
                                    <small class="text-muted mb-1 d-inline-block">45%</small>
                                </div>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" role="progressbar" style="width: 45%;" aria-valuenow="45"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                        <!-- End task -->
                        <!-- Start task -->
                        <div class="card mb-3 cursor-grab">
                            <div class="card-body">
                                <p class="mb-0">Anything can be moved around. That includes images, links or any other
                                    nested elements.</p>
                                <div class="text-right">
                                    <small class="text-muted mb-1 d-inline-block">75%</small>
                                </div>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" role="progressbar" style="width: 75%;" aria-valuenow="75"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                        <!-- End task -->
                    </div>
                    <div class="btn btn-primary btn-block">Add task</div>
                </div>
            </div>
        </div>
        <!-- End lane -->

        <!-- Start lane -->
        <div class="col-12 col-lg-4">
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h3 class="card-title h5 mb-1">
                        Completed
                    </h3>
                    <small class="mb-0 text-muted">
                        Curabitur ligula sapien, tincidunt non.
                    </small>
                </div>
                <div class="card-body">
                    <div class="tasks" id="completed">
                        <!-- Start task -->
                        <div class="card mb-3 cursor-grab">
                            <img class="card-img-top" src="https://source.unsplash.com/zNRITe8NPqY/400x200"
                                 alt="Bootstrap Kanban Board"/>
                            <div class="card-body">
                                <span class="badge bg-warning text-white mb-2">Enhancement</span>
                                <p class="mb-0">Moving them anywhere else isn't quite possible</p>
                                <div class="text-right">
                                    <small class="text-muted mb-1 d-inline-block">95%</small>
                                </div>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" role="progressbar" style="width: 95%;" aria-valuenow="85"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                        <!-- End task -->
                        <!-- Start task -->
                        <div class="card mb-3 cursor-grab">
                            <div class="card-body">
                                <p class="mb-0">You can move these elements between the containers</p>
                                <div class="text-right">
                                    <small class="text-muted mb-1 d-inline-block">80%</small>
                                </div>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" role="progressbar" style="width: 80%;" aria-valuenow="80"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                        <!-- End task -->
                    </div>
                    <div class="btn btn-primary btn-block">Add task</div>
                </div>
            </div>
        </div>
        <!-- End lane -->

    </div>
</div>
<script>
    let dragulaCard;
    let dragulaList;
    $(function () {

        setCardDraggable();
        setListDraggable();
    });

    const dragger = {
        init(target, options) {
            return dragula(
                [
                    ...target // 해당 리스트의 아이템을 드래그 가능하게 만듦
                ],
                options
            );
        },
        setSiblings({el, target, items, type}) {
            // 계산에 사용할 앞과 뒤의 카드 선언
            let prev = null;
            let next = null;

            items.forEach((item, index, arr) => {
                // 리스트의 아이템들을 순환
                if (item.dataset[type + "Id"] * 1 === el.dataset[type + "Id"] * 1) {
                    // 현재 드래그하는 카드일 경우
                    prev = index > 0 ? arr[index - 1] : null; // 맨 위가 아닐 경우 이전 아이템 할당
                    next = index < arr.length - 1 ? arr[index + 1] : null; // 맨 아래가 아닐 경우 다음 아이템 할당
                }
            });

            return {prev, next};
        }
    };

    function viewColumns(arr) {
        console.log(arr)
    }
    function setCardDraggable() {
        if (this.dragulaCard) this.dragulaCard.destroy();

        const options = {};

        this.dragulaCard = dragger.init(
            Array.from(document.querySelectorAll(".tasks")),
            options
        );

        this.dragulaCard.on("drop", (el, target, source, sibling) => {
            // 이벤트 리스너 등록(el은 드래그하는 요소, target은 위에서 등록한 리스트)
            const targetCard = {
                id: el.dataset.cardId * 1,
                listId: target.parentNode.dataset.listId * 1,
                pos: 65535
            }; // api업데이트시 쓰일 객체 생성

            const {prev, next} = dragger.setSiblings({
                el,
                target,
                items: target.querySelectorAll(".card-item"),
                type: "card"
            });

            // 자리가 맨 위일 경우
            if (!prev && next) targetCard.pos = next.dataset.pos / 2;
            // 자리가 사이일 경우
            else if (prev && next)
                targetCard.pos = prev.dataset.pos / 2 + next.dataset.pos / 2;
            // 자리가 맨 아래일 경우
            else if (prev && !next) targetCard.pos = prev.dataset.pos * 2;

            this.updateCard(targetCard);
        });
    }

    function setListDraggable() {
        if (this.dragulaList) this.dragulaList.destroy();

        const options = {
            invalid: (el, handle) => {
                return !/^col-12/.test(handle.className); // 클릭한 요소(handle)의 클래스가 list로 시작하는지 test()해서 true false 반환
            }
        };

        this.dragulaList = dragger.init(
            Array.from(document.querySelectorAll(".col-12")),
            options
        );
        console.log("zz->" + dragulaList)

        this.dragulaList.on("drop", (el, target, source, sibling) => {
            // 이벤트 리스너 등록(el은 드래그하는 요소, target은 위에서 등록한 리스트)
            const targetList = {
                id: el.dataset.listId * 1,
                pos: 65535
            }; // api업데이트시 쓰일 객체 생성

            const {prev, next} = dragger.setSiblings({
                el,
                target,
                items: target.querySelectorAll(".list"),
                type: "list"
            });

            // 자리가 맨 위일 경우
            if (!prev && next) targetList.pos = next.dataset.pos / 2;
            // 자리가 사이일 경우
            else if (prev && next)
                targetList.pos = prev.dataset.pos / 2 + next.dataset.pos / 2;
            // 자리가 맨 아래일 경우
            else if (prev && !next) targetList.pos = prev.dataset.pos * 2;

            this.updateList(targetList);
        });
    };

    function updateCard(card) {

    }

    function updateList(targetList) {

    }
</script>
</body>
</html>